<!DOCTYPE html>
<html>
    <head>
        <style>
            ul{
                list-style: none;
            }
            li{
                list-style: none;
            }
            .tree_node + ul{
                display: none;
            }
            .tree_node.show + ul{
                display: block;
            }            
        </style>
    </head>
    <body>
        <tree-componenet data-group='tree_01'></tree-componenet>
        <br>
        <div id='checkContainer'>
            <div id="addItemCheckContainer">
                <input type="text" placeholder="element_id" value=''>
                <input type="text" placeholder="element_pid" value=''>
                <input type="text" placeholder="element_name" value=''>
                <input type="text" placeholder="element_description" value=''>
                <button id='addItemCheckButton'>addItemCheckButton</button>
            </div>
            <div id="checkRadioCheckContainer">
                <input type='text' placeholder='element_id for radioButton ...'>
                <button id='checkRadioButton'>checkRadioButton</button>
            </div>
            <div id="checkCheckBoxContainer">
                <input type='text' placeholder='element_id for checkBox ...'>
                <button id='checkCheckBoxButton'>checkCheckBoxButton</button>
            </div>
            <div id="nodeDataCheckContainer">
                <button id='nodeDataCheckButton'>nodeDataCheckButton</button>
            </div>
        </div>

        <script>
            // let serverURL = 'http://192.168.0.51:5000/dataFromServer';
            // let serverURL = 'http://192.168.56.1:5000/dataFromServer';
            // let serverURL = `http://192.168.56.1:5000/dataFromDb`;
            class tree extends HTMLElement{
                constructor(){
                    super();
                    this.serverURL = `http://192.168.56.1:5000/dataFromDb`;
                }

                connectedCallback(){
                    this.nodeIdArray = [];
                    this.nodeList = {};
                    this.render();
                    this.setEvent();
                }

                async getDataFromServer(){
                    // let response = await fetch('http://192.168.0.51:5000/dataFromServer');
                    // let response = await fetch('http://192.168.56.1:5000/dataFromServer');
                    let response = await fetch(this.serverURL+`?query=WITH recursive cte (id, pid, NAME, description) as(
                                                    SELECT id, pid, NAME, description
                                                    FROM tree_table
                                                    WHERE pid=0
                                                    UNION all
                                                    SELECT a.id, a.pid, a.name, a.description
                                                    FROM tree_table a
                                                    INNER JOIN cte
                                                    ON a.pid = cte.id
                                                )
                                                SELECT * FROM cte ORDER BY pid asc, id asc;`);
                    let responseJson = await response.json();
                    this.componentData = responseJson;
                }

                async render(){
                    await this.getDataFromServer();
                    await this.constructTreeWithInitialData();
                }

                constructTreeWithInitialData(){
                    for(var i=0; i<this.componentData.length; i++){
                        let tempObject = this.componentData[i];
                        this.addItem(tempObject.pid, tempObject);
                    }
                }

                checkchildren(element, querySelector){
                    let childNodeList = element.children;
                    for(var i=0; i<element.children.length; i++){
                        if(childNodeList[i].matches(querySelector)){
                            return true; // 해당 element를 포함하고 있음
                        }
                    }
                    return false; // 해당 element를 포함하고 있지 않음
                }

                setEvent(){
                    this.customClickEventListener();
                }

                customClickEventListener(){
                    this.addEventListener('click', function(e){
                        this.getSelectedId(e);
                        this.getSelectedItem(e);
                        this.toggelingTreeNodeToShow(e);                        
                    });
                    document.addEventListener('click', (e)=>{ //arrow function을 사용하지 않을 경우 this 바인딩 객체 문제
                        this.addItemEventListener(e);
                        this.checkRadio(e);
                        this.checkItem(e);
                    });
                }

                checkItem(event){
                    if(event.target == document.querySelector('#checkCheckBoxButton')){
                        let id = parseInt(event.target.parentElement.children[0].value);
                        let targetNode = document.querySelector('div[data-id="'+ id +'"]');
                        let targetNodeCheckBox = targetNode.querySelector('input[type="checkbox"]');
                        if(targetNodeCheckBox.checked== false || targetNodeCheckBox.checked == undefined){
                            targetNodeCheckBox.checked=true;
                        }else{
                            targetNodeCheckBox.checked=false;
                        }
                    }
                }

                checkRadio(event){
                    if(event.target == document.querySelector('#checkRadioButton')){
                        let id = parseInt(event.target.parentElement.children[0].value);
                        let targetNode = document.querySelector('div[data-id="'+ id +'"]');
                        let targetNodeRadio = targetNode.querySelector('input[type="radio"]');
                        if(targetNodeRadio.checked== false || targetNodeRadio.checked == undefined){
                            targetNodeRadio.checked=true;
                        }else{
                            targetNodeRadio.checked=false;
                        }
                        
                    }
                }

                // addItem() 작동을 확인하는 이벤트 리스너
                addItemEventListener(event){
                    if(event.target == document.querySelector('#addItemCheckButton')){
                        let elementData = {
                            'id' : parseInt(event.target.parentElement.children[0].value),
                            'pid' : parseInt(event.target.parentElement.children[1].value),
                            'NAME' : event.target.parentElement.children[2].value,
                            'description' : event.target.parentElement.children[3].value
                        };
                        let pid = event.target.parentElement.children[1].value;
                        this.addItem(pid, elementData);
                    }
                }

                toggelingTreeNodeToShow(event){
                    if(event.target.matches('div.tree_node')){
                        event.target.classList.toggle('show');
                    }
                }

                getSelectedId(event){
                    if(event.target.matches('div.tree_node')){
                        console.log('check elementId in getSelectedId() : ' + event.target.dataset.id);
                    }
                }

                getSelectedItem(event){
                    if(event.target.matches('div.tree_node')){
                        console.log('check elementId in getSelectedItem() ... ');
                        console.log(event.target.nodeData);
                    }
                }

                addItem(pid, elementData){
                    let tempElement = document.createElement('div');
                    tempElement.innerText = elementData['NAME'];
                    tempElement.setAttribute('data-id', elementData['id']);
                    tempElement.setAttribute('class', 'tree_node');
                    tempElement.nodeData = elementData;
                    
                    if(!this.nodeIdArray.includes(elementData['pid'])){
                        this.appendChild(tempElement);
                    }else{ // pid가 존재하는 경우에 ...
                        if(!this.checkchildren(this.nodeList[pid].parentElement, 'ul')){       //ul 태그가 존재하지않는다면 ...
                            let tempUl = document.createElement('ul');
                            let tempLi = document.createElement('li');
                            tempLi.appendChild(tempElement);
                            tempUl.appendChild(tempLi);
                            this.nodeList[pid].after(tempUl);       
                        }else{                                                              //ul 태그가 있다면 ...                                                 
                            let tempLi = document.createElement('li');
                            tempLi.appendChild(tempElement);
                            this.nodeList[pid].nextElementSibling.appendChild(tempLi);
                        }
                    }
                    this.addCheckBoxButton(tempElement);
                    this.addRadioButton(tempElement);                    
                    this.nodeIdArray.push(elementData.id);
                    this.nodeList[elementData.id] = tempElement; // id, element 쌍으로 객체에 저장
                }

                addCheckBoxButton(element){
                    let tempElement = document.createElement('input');
                    tempElement.setAttribute('type', 'checkbox');
                    element.prepend(tempElement);                    
                }

                addRadioButton(element){
                    let tempElement = document.createElement('input');
                    tempElement.setAttribute('type', 'radio');
                    tempElement.setAttribute('name', this.dataset.group);
                    element.appendChild(tempElement);
                }

            }
            customElements.define('tree-componenet', tree);
        </script>
    </body>
</html>